// 测试程序  测试库的可用性

#include "stdio.h" /* 包含标准输入输出文件 */

#include "stdlib.h"

#include "dlfcn.h" /* 包含动态链接功能接口文件 */

#define OPENVPNSO "./libopenvpn.so" /* 指定动态链接库名称 */

#define SHARED /* 定义宏,确认共享,以便引用动态函数 */

//#include "oldman.h" /* 包含用户接口文件 */

int main() {

	void *dp;
	char *error;

	puts("动态链接库应用示范");

	//打开动态链接库
	dp = dlopen(OPENVPNSO, RTLD_LAZY); /* 打开动态链接库 */

	if (dp == NULL ) /* 若打开失败则退出 */
	{
		fputs(dlerror(), stderr);
		exit(1);
	} else {
		puts("打开成功");
	}

	//定位函数位置
	typedef int (*open_vpn_test)(int argc, char *argv[]);
	open_vpn_test test = NULL;

	test = (open_vpn_test) dlsym(dp, "old_main");

	error = dlerror(); /* 检测错误 */
	if (error) /* 若出错则退出 */
	{
		fputs(error, stderr);
		exit(1);
	}

	//调用此函数
	char* arg[] = { "openvpn", "--config", "/root/VPN_workspace/libOpenTest/client.config" };

	test(3, arg);

	return 0;
}
