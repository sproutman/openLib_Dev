#include "stdio.h" /* 包含标准输入输出文件 */

#include "stdlib.h"

#include <unistd.h>
#include <sys/types.h>

#include <string.h>

#include <signal.h>

#include "dlfcn.h" /* 包含动态链接功能接口文件 */

#define OPENVPNSO "./libopenvpn.so" /* 指定动态链接库名称 */

#define SHARED /* 定义宏,确认共享,以便引用动态函数 */

#include "oldman.h" /* 包含用户接口文件 */

///////////////////////////////////////////////////////////////////////////////////

int main() {

	void *dp;
	char *error;

	puts("动态链接库应用示范");

	//打开动态链接库
	dp = dlopen(OPENVPNSO, RTLD_LAZY); /* 打开动态链接库 */

	if (dp == NULL ) /* 若打开失败则退出 */
	{
		fputs(dlerror(), stderr);
		exit(1);
	} else {
		puts("打开成功");
	}

////////////////////////////////////////////////////////////////////////////////////

//定位start函数位置
	typedef int (*open_vpn_test)(int argc, char *argv[]);
	open_vpn_test test = NULL;
	test = (open_vpn_test) dlsym(dp, "old_main");

	//open_vpn_test=dlsym( dp, "old_main" );
	error = dlerror(); /* 检测错误 */
	if (error) /* 若出错则退出 */
	{
		fputs(error, stderr);
		exit(1);
	}

	//调用此函数
	char* arg[] = { "openvpn", "--config", "./client.config" };

	// 启动openVPN
	//while(1)
	//{
	char buf[1024];
	memset(buf, 0, 1024);
	printf("Input what you function u want\n");
	printf("Input start here  \n");
	//scanf("%s", buf);
	gets(buf);

	if (strcmp(buf, "start") == 0) {

		//printf("%d",fflush(0));
		//while(getchar() != '\n');
		// close(0);
		//     open(0);

		int cPid;
		cPid = fork();
		//printf(" cPid = %d", cPid);
		//sleep(4);
		if (cPid == 0) {
			//start openvpn  子进程
			printf("Test \n");
			test(3, arg);
			//manage Interface
		}
		//sleep(20);
		//printf(" *******cPid = %d", cPid);

		//TODO  调用连接管理端口的程序  执行管理功能
		//	printf("create TCP_Connect to mangerment port\n");
		//	initPcCLient();
	}

	//}

///////////////////////////////////////////////////////////////////////////////////////////
	sleep(10);
	while (1) {
		//
		char buf0[1024];
		memset(buf0, 0, 1024);
		printf("Input what you function u want\n");
		printf(" stop  restart or state \n");

		gets(buf0);

		//
		if (strcmp(buf0, "stop") == 0) {
			printf("Stop ?!!\n");
			typedef int (*open_vpn_stop)();
			open_vpn_stop vpnstop = NULL;
			vpnstop = (open_vpn_stop) dlsym(dp, "stopOpenvpn");

			if (NULL == vpnstop)
				printf("NULL  Pointer !!! \n");
			else {
				printf("******   %p ***** ", vpnstop);
			}
			error = dlerror(); /* 检测错误 */
			if (error) /* 若出错则退出 */
			{
				fputs(error, stderr);
				exit(1);
			} else {
				printf("定位函数OK ！！！\n");
			}

			//char buf1[1024];
			//memset(buf1, 0, 1024);
			//printf("Input what you function u want\n");
			//printf("start stop  restart or state \n");
			//scanf("%s", buf);
			//gets(buf1);

			//关闭openVPN
			//		if(strcmp(buf1, "stop") == 0)
			//	{
			int stopFlag;
			stopFlag = vpnstop();
			printf("stopFlag = %d\n", stopFlag);
			if (0 != stopFlag) {
				printf("Stop unexpectly!!! \n");
			}
			//		}

		} else if (strcmp(buf0, "restart") == 0) {
			printf("Restart ?? !!!\n");
			typedef int (*open_vpn_reopenvpn)();
			open_vpn_reopenvpn vpnrestart = NULL;
			vpnrestart = (open_vpn_reopenvpn) dlsym(dp, "restartVpn");

			if (NULL == vpnrestart)
				printf("NULL  Pointer !!! \n");
			else {
				printf("******   %p ***** ", vpnrestart);
			}
			error = dlerror(); /* 检测错误 */
			if (error) /* 若出错则退出 */
			{
				fputs(error, stderr);
				exit(1);
			} else {
				printf("定位函数OK ！！！\n");
			}

			//char buf2[1024];
			//memset(buf2, 0, 1024);
			//printf("Input what you function u want\n");
			//printf("start stop  restart or state \n");
			//scanf("%s", buf);
			//gets(buf2);

			//关闭openVPN
			//if(strcmp(buf2, "restart") == 0)
			//{
			int restartFlag;
			restartFlag = vpnrestart();
			printf("stopFlag = %d\n", restartFlag);
			if (0 != restartFlag) {
				printf("restart unexpectly!!! \n");
			}

		} else if (strcmp(buf0, "state") == 0) {

			// sleep(10);
			printf("state ?? !!!\n");
			typedef int (*open_vpn_statevpn)();
			open_vpn_statevpn vpnstate = NULL;
			vpnstate = (open_vpn_statevpn) dlsym(dp, "getState");

			if (NULL == vpnstate)
				printf("NULL  Pointer !!! \n");
			else {
				printf("******   %p ***** ", vpnstate);
			}
			error = dlerror(); /* 检测错误 */
			if (error) /* 若出错则退出 */
			{
				fputs(error, stderr);
				exit(1);
			} else {
				printf("定位函数OK ！！！\n");
			}

			// 	while(1)
			//{
			//char buf3[1024];
			//memset(buf3, 0, 1024);
			//printf("Input what you function u want\n");
			//printf("start stop  restart or state \n");
			//scanf("%s", buf);
			//gets(buf3);

			//关闭openVPN
			//		if(strcmp(buf3, "state") == 0)
			//		{
			int stateFlag;
			stateFlag = vpnstate();
			printf("stateFlag = %d\n", stateFlag);
			if (0 != stateFlag) {
				printf("stateFlag unexpectly!!! \n");
			}
			//	}
		} else {
			printf(
					"what else do you want to do on the earth ? stop? restart or state ??? !!!\n");
		}

	}

	//关闭此动态链接库
	//dlclose(dp);

	return 0;

}

/*end of file*/
